// ÌÜµÌï© Jenkinsfile (ÏÑ†ÌÉùÏ†Å ÎπåÎìú Î∞è ÏÉÅÏÑ∏ ÏïåÎ¶º Ï†ÅÏö©)
pipeline {
    agent any

    stages {
        stage('Prepare Environment') {
            steps {
                script {
                    def target = env.gitlabTargetBranch ?: 'dev'
                    if (target == 'dev') {
                        echo "### Target branch is 'dev'. Setting DEV environment. ###"
                        env.CREDENTIALS_ID = 'DEV_PROPERTIES'
                        env.IMAGE_NAME     = 'backend-app-dev'
                        env.CONTAINER_NAME = 'backend-app-dev'
                    } else {
                        echo "### Target branch is 'master'. Setting PROD environment. ###"
                        env.CREDENTIALS_ID = 'PROD_PROPERTIES'
                        env.IMAGE_NAME     = 'backend-app'
                        env.CONTAINER_NAME = 'backend-app'
                    }
                }
            }
        }

        // =================================================================
        // 2. Î∞±ÏóîÎìú CI/CD (backend Ìè¥ÎçîÏóê Î≥ÄÍ≤ΩÏù¥ ÏûàÏùÑ ÎïåÎßå Ïã§Ìñâ)
        // =================================================================
        stage('Backend CI/CD') {
            when { changeset "backend/**" }
            stages {
                stage('Build Backend') {
                    steps {
                        dir('backend') {
                            sh 'chmod +x ./gradlew'
                            sh './gradlew clean build -x test'
                        }
                    }
                }
                stage('Build Docker Image') {
                    steps {
                        dir('backend') {
                            sh 'docker build -t "$IMAGE_NAME" .'
                        }
                    }
                }
                stage('Deploy Backend') {
                    steps {
                        withCredentials([
                            file(credentialsId: env.CREDENTIALS_ID, variable: 'PROPERTIES_FILE_PATH'),
                            file(credentialsId: 'gcp-credentials-json', variable: 'GCP_CREDENTIALS_FILE'),
                            file(credentialsId: 'firebase-service-account-json', variable: 'FIREBASE_CREDENTIALS_FILE')
                        ]) {
                            script {
                                sh 'docker stop "$CONTAINER_NAME" || true'
                                sh 'docker rm "$CONTAINER_NAME" || true'
                                sh '''
                                  docker create \
                                    --name "$CONTAINER_NAME" \
                                    --network=cocos-network \
                                    --env-file "$PROPERTIES_FILE_PATH" \
                                    -e GCP_CREDENTIALS_LOCATION="/run/secrets/gcp.json" \
                                    -e FCM_SERVICE_ACCOUNT_FILE_LOCATION="file:/run/secrets/firebase.json" \
                                    "$IMAGE_NAME"
                                  docker start "$CONTAINER_NAME"
                                  docker exec "$CONTAINER_NAME" sh -c 'mkdir -p /run/secrets && chmod 700 /run/secrets'
                                  docker stop "$CONTAINER_NAME"
                                  docker cp "$GCP_CREDENTIALS_FILE" "$CONTAINER_NAME":/run/secrets/gcp.json
                                  docker cp "$FIREBASE_CREDENTIALS_FILE" "$CONTAINER_NAME":/run/secrets/firebase.json
                                  docker start "$CONTAINER_NAME"
                                  docker exec "$CONTAINER_NAME" sh -c 'chmod 600 /run/secrets/gcp.json'
                                  docker exec "$CONTAINER_NAME" sh -c 'chmod 600 /run/secrets/firebase.json'
                                '''
                            }
                        }
                    }
                }
            }
            post {
                success {
                    // --- [ÏàòÏ†ï] ÏöîÏ≤≠ÌïòÏã† ÏÉÅÏÑ∏ ÏïåÎ¶º Ìè¨Îß∑ÏúºÎ°ú Î≥µÏõê ---
                    withCredentials([string(credentialsId: 'mattermost-webhook', variable: 'MM_URL')]) {
                        sh '''#!/usr/bin/env sh
                            set -eu
                            COMMIT7=$(printf "%s" "${GIT_COMMIT}" | cut -c1-7)
                            TARGET="${gitlabTargetBranch:-dev}"
                            TS=$(date +%s)

                            COLOR="#2ecc71"
                            TEXT="### :pepe_jam: Dev Updated! :pepe_jam:"
                            if [ "$TARGET" = "master" ]; then
                                COLOR="#228be6"
                                TEXT="### :crown: Backend Deployed! :crown:"
                            fi

                            JSON=$(printf '{
                                "text": "%s",
                                "attachments": [{
                                    "pretext": "@channel",
                                    "color": "%s",
                                    "title": "%s #%s",
                                    "title_link": "%s",
                                    "text": "Î∏åÎûúÏπò: `%s`\\nÏª§Î∞ã: `%s`\\nÏù¥ÎØ∏ÏßÄ: `%s`",
                                    "fields": [
                                        {"title":"Job","value":"%s","short":true},
                                        {"title":"Build","value":"#%s","short":true},
                                        {"title":"Branch","value":"%s","short":true},
                                        {"title":"Commit","value":"%s","short":true},
                                        {"title":"Docker Image","value":"%s","short":false}
                                    ],
                                    "footer": "Jenkins",
                                    "ts": %s
                                }]
                            }' \
                            "$TEXT" "$COLOR" "$JOB_NAME" "$BUILD_NUMBER" "$BUILD_URL" \
                            "$TARGET" "$COMMIT7" "$IMAGE_NAME" \
                            "$JOB_NAME" "$BUILD_NUMBER" "$TARGET" "$COMMIT7" "$IMAGE_NAME" "$TS")

                            curl -sS -X POST -H 'Content-Type: application/json' -d "$JSON" "$MM_URL"
                        '''
                    }
                }
            }
        }

        // =================================================================
        // 3. APK ÎπåÎìú Î∞è Í≤åÏãú (frontend Ìè¥ÎçîÏóê Î≥ÄÍ≤ΩÏù¥ ÏûàÏùÑ ÎïåÎßå Ïã§Ìñâ)
        // =================================================================
        stage('Build & Publish APK') {
            when { changeset "frontend/**" }
            steps {
                script {
                    def ANDROID_SDK_ROOT = "/opt/android-sdk"
                    def nodeJS = tool name: 'NodeJS-20'
                    
                    withEnv([
                        "ANDROID_HOME=${ANDROID_SDK_ROOT}",
                        "PATH+NODE=${nodeJS}/bin"
                    ]) {
                        dir('frontend/cocosforest') {
                            sh 'npm install'
                        }
                        dir('frontend/cocosforest/android') {
                            sh 'chmod +x ./gradlew'
                            sh './gradlew clean assembleRelease'
                        }
                        def apkSourcePath = "frontend/cocosforest/android/app/build/outputs/apk/release/app-release.apk"
                        def apkPublishDir = "/apk_publish"
                        def versionedApkName = "backend-v${env.BUILD_NUMBER}.apk"
                        def latestApkName = "latest.apk"
                        sh "cp ${apkSourcePath} ${apkPublishDir}/${versionedApkName}"
                        sh "cp ${apkPublishDir}/${versionedApkName} ${apkPublishDir}/${latestApkName}"
                    }
                }
            }
            post {
                success {
                    withCredentials([string(credentialsId: 'mattermost-webhook', variable: 'MM_URL')]) {
                        sh '''#!/usr/bin/env sh
                            set -eu
                            COMMIT7=$(printf "%s" "${GIT_COMMIT}" | cut -c1-7)
                            TARGET="${gitlabTargetBranch:-dev}"

                            JSON=$(printf '{
                                "text": "### :android: New APK Build Ready!",
                                "attachments": [{
                                    "color": "#a0e989",
                                    "title": "APK ÎπåÎìú ÏÑ±Í≥µ: %s #%s",
                                    "title_link": "%s",
                                    "text": "Î∏åÎûúÏπò: `%s`\\nÏª§Î∞ã: `%s`\\n[**ÏµúÏã† APK Îã§Ïö¥Î°úÎìú**](https://j13e205.p.ssafy.io/download/latest.apk)"
                                }]
                            }' "$JOB_NAME" "$BUILD_NUMBER" "$BUILD_URL" "$TARGET" "$COMMIT7")

                            curl -sS -X POST -H 'Content-Type: application/json' -d "$JSON" "$MM_URL"
                        '''
                    }
                }
            }
        }
    }

    post {
        failure {
            withCredentials([string(credentialsId: 'mattermost-webhook', variable: 'MM_URL')]) {
                sh '''#!/usr/bin/env sh
                    set -eu
                    TARGET="${gitlabTargetBranch:-dev}"
                    JSON=$(printf '{"text":":boom: **Î∞∞Ìè¨ Ïã§Ìå®!** :boom:\\n- **Job**: %s\\n- **Build**: #%s\\n- **Branch**: %s\\nüîó [ÏóêÎü¨ Î°úÍ∑∏ ÌôïÏù∏](%s)\\n@here"}' \
                          "$JOB_NAME" "$BUILD_NUMBER" "$TARGET" "$BUILD_URL")
                    curl -sS -X POST -H 'Content-Type: application/json' -d "$JSON" "$MM_URL"
                '''
            }
        }
        unstable {
            withCredentials([string(credentialsId: 'mattermost-webhook', variable: 'MM_URL')]) {
                sh '''#!/usr/bin/env sh
                    set -eu
                    JSON=$(printf '{"text":":warning: **ÎπåÎìú Î∂àÏïàÏ†ï!** :warning:\\n- **Job**: %s\\n- **Build**: #%s\\nüîó [ÏûêÏÑ∏Ìûà Î≥¥Í∏∞](%s)"}' \
                          "$JOB_NAME" "$BUILD_NUMBER" "$BUILD_URL")
                    curl -sS -X POST -H 'Content-Type: application/json' -d "$JSON" "$MM_URL"
                '''
            }
        }
        always {
            cleanWs()
        }
    }
}

